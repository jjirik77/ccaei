<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cybersecurity Career Assessment - Baseline v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar-fill { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .framework-card { transition: all 0.2s ease-in-out; border-width: 2px; }
        .framework-card.recommended { border-color: #22d3ee; background-color: rgba(31, 41, 55, 0.5); box-shadow: 0 0 20px rgba(34, 211, 238, 0.15); }
        .interest-bar-fill { background-color: #22d3ee; transition: width 0.6s ease-out; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: #1f2937; padding: 2.5rem; border-radius: 1.5rem; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto; border: 1px solid #374151; }
        .clarity-bar-bg { background-color: #111827; height: 8px; border-radius: 4px; position: relative; overflow: hidden; }
        .clarity-fill { height: 100%; background: linear-gradient(to right, #06b6d4, #22d3ee); transition: width 0.8s ease-out; }
        .trait-label { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #9ca3af; }
        .rating-anchor { font-size: 0.7rem; color: #6b7280; font-style: italic; margin-top: 0.5rem; display: block; height: 1.5rem; }
        .conflict-badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.4); }
        .time-badge { font-size: 0.7rem; color: #10b981; background: rgba(16, 185, 129, 0.1); padding: 2px 8px; border-radius: 99px; font-weight: 600; border: 1px solid rgba(16, 185, 129, 0.2); }
        button:focus { outline: 2px solid #22d3ee; outline-offset: 2px; }
        .text-shadow { text-shadow: 0 0 20px rgba(34, 211, 238, 0.3); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="assessment-container" class="w-full max-w-5xl mx-auto bg-gray-800 rounded-3xl shadow-2xl p-6 md:p-12 transition-all duration-500 border border-gray-700">

        <!-- Start Screen -->
        <div id="start-screen" class="text-center fade-in">
            <h1 class="text-4xl md:text-5xl font-extrabold text-cyan-400 mb-6 tracking-tight">Cybersecurity Career Assessment</h1>
            <p class="text-gray-300 mb-8 text-xl max-w-2xl mx-auto leading-relaxed">
                <span class="text-white font-bold">Baseline v3.0:</span> Verified Institutional Diagnostic for <span class="text-cyan-300 font-semibold">NICE / DCWF</span> Career Alignment and Cognitive Processing.
            </p>
            <div class="bg-gray-900/50 p-6 rounded-2xl mb-8 border border-gray-700 max-w-lg mx-auto">
                <div class="flex items-start text-left">
                    <input id="consent-checkbox" type="checkbox" class="mt-1 h-5 w-5 rounded border-gray-600 bg-gray-800 text-cyan-500 focus:ring-cyan-500 transition-colors">
                    <label for="consent-checkbox" class="ml-3 block text-sm text-gray-400 leading-snug cursor-pointer">
                        I consent to the collection of anonymized decision-speed and response telemetry for institutional research and psychometric validation.
                    </label>
                </div>
            </div>
            <button id="start-btn" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-4 px-10 rounded-xl text-xl transition-all transform hover:scale-105 shadow-lg shadow-cyan-500/20">
                Begin Assessment
            </button>
        </div>

        <!-- Stage 1 Quiz -->
        <div id="quiz-screen-stage1" class="hidden fade-in">
            <div class="mb-10">
                <div class="flex justify-between items-end mb-3">
                    <div>
                        <span id="question-counter-stage1" class="text-xs font-bold uppercase tracking-widest text-cyan-500"></span>
                        <h2 class="text-lg font-medium text-gray-400">Phase 1: Cognitive Baseline</h2>
                    </div>
                    <span id="progress-text-stage1" class="text-sm font-bold text-cyan-400"></span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                    <div id="progress-bar-stage1" class="bg-cyan-500 h-3 rounded-full progress-bar-fill shadow-[0_0_15px_rgba(34,211,238,0.4)]"></div>
                </div>
            </div>
            <h3 class="text-2xl md:text-3xl font-bold mb-10 text-gray-100 text-center leading-tight">Which environment describes you better?</h3>
            <div id="answers-container-stage1" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
        
        <!-- Intermediate Transition -->
        <div id="intermediate-screen" class="hidden fade-in text-center py-12">
            <div class="mb-6 inline-flex p-4 rounded-full bg-cyan-500/10 text-cyan-400 animate-pulse">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <h2 class="text-3xl font-bold text-white mb-4">Baseline Established</h2>
            <p class="text-gray-400 mb-10 text-lg max-w-md mx-auto">Decision latencies analyzed. Proceeding to Phase 2 for evidence-based task validation and final role matching.</p>
            <button id="start-stage2-btn" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-4 px-10 rounded-xl text-xl transition-all shadow-lg">
                Start Task Validation
            </button>
        </div>

        <!-- Stage 2 Quiz -->
        <div id="quiz-screen-stage2" class="hidden fade-in">
            <div class="mb-10">
                <div class="flex justify-between items-end mb-3">
                    <div>
                        <span id="question-counter-stage2" class="text-xs font-bold uppercase tracking-widest text-cyan-500"></span>
                        <h2 class="text-lg font-medium text-gray-400">Phase 2: Task Interest Evidence</h2>
                    </div>
                    <span id="progress-text-stage2" class="text-sm font-bold text-cyan-400"></span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-3">
                    <div id="progress-bar-stage2" class="bg-cyan-500 h-3 rounded-full progress-bar-fill"></div>
                </div>
            </div>
            <h3 class="text-2xl font-semibold mb-4 text-gray-100 text-center">How would you enjoy performing this task?</h3>
            <p id="interest-question-text" class="text-center text-xl text-cyan-100 mb-10 min-h-[4rem] font-medium px-4"></p>
            <div id="interest-answers-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto"></div>
        </div>

        <!-- Results View -->
        <div id="results-screen" class="hidden fade-in">
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-black text-cyan-400 mb-2 uppercase tracking-tighter text-shadow">Career Diagnosis</h1>
                <div id="profile-summary" class="mt-4"></div>
            </div>

            <!-- Cognitive Section -->
            <div class="bg-gray-900/50 p-8 rounded-2xl mb-12 border border-gray-700 shadow-inner">
                <div class="flex justify-between items-center mb-8">
                    <div class="flex flex-col text-left">
                        <h3 class="text-sm font-bold text-cyan-500 uppercase tracking-widest">Cognitive Clarity & Identity Flex</h3>
                        <p class="text-[10px] text-gray-500 italic">Analysis based on decision latency and trait-foil preference.</p>
                    </div>
                    <div id="overall-flex-badge"></div>
                </div>
                <div id="clarity-container" class="grid grid-cols-1 md:grid-cols-2 gap-x-16 gap-y-10"></div>
            </div>
            
            <div id="top-roles-container" class="mb-12 space-y-10"></div>
            
            <div id="gated-roles-container" class="hidden mb-12">
                <button id="toggle-gated-btn" class="w-full text-left flex items-center justify-between p-4 bg-gray-900/50 rounded-xl border border-gray-700 text-gray-400 hover:text-white transition-colors">
                    <span class="font-bold text-sm uppercase tracking-widest">Secondary Career Potential</span>
                    <span id="gated-arrow">▼</span>
                </button>
                <div id="gated-content" class="hidden pt-4 space-y-4"></div>
            </div>

            <div class="flex flex-col md:flex-row items-center justify-center gap-6 pt-10 border-t border-gray-700">
                <button id="restart-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-10 rounded-xl transition-all w-full md:w-auto">
                    Retake Assessment
                </button>
                <button id="export-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-10 rounded-xl transition-all w-full md:w-auto flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Export Telemetry
                </button>
            </div>
        </div>
    </div>
    
    <!-- Telemetry Modal -->
    <div id="export-modal" class="modal-overlay hidden">
        <div class="modal-content fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-cyan-400">Diagnostic Telemetry Export</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl font-light">&times;</button>
            </div>
            <textarea id="json-output" readonly class="w-full h-80 p-4 bg-gray-900 text-cyan-100 border border-gray-700 rounded-xl font-mono text-xs focus:ring-0"></textarea>
            <div class="mt-6 flex justify-end gap-4">
                <button id="copy-json-btn" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-8 rounded-xl transition-all">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <script>
    /**
     * Assessment Version: v3.0-baseline
     * Standards Compliance: NICE Framework (NIST SP 800-181) | DCWF (DoD Cyber Workforce)
     */
    document.addEventListener('DOMContentLoaded', () => {
        const get = id => document.getElementById(id);
        const elements = {
            startBtn: get('start-btn'), startStage2Btn: get('start-stage2-btn'),
            restartBtn: get('restart-btn'), exportBtn: get('export-btn'),
            closeModalBtn: get('close-modal-btn'), copyJsonBtn: get('copy-json-btn'),
            toggleGatedBtn: get('toggle-gated-btn'), consentCheckbox: get('consent-checkbox'),
            startScreen: get('start-screen'), quiz1: get('quiz-screen-stage1'),
            intermediate: get('intermediate-screen'), quiz2: get('quiz-screen-stage2'),
            results: get('results-screen'), exportModal: get('export-modal'),
            progBar1: get('progress-bar-stage1'), progText1: get('progress-text-stage1'),
            count1: get('question-counter-stage1'), container1: get('answers-container-stage1'),
            progBar2: get('progress-bar-stage2'), progText2: get('progress-text-stage2'),
            count2: get('question-counter-stage2'), interestText: get('interest-question-text'),
            container2: get('interest-answers-container'), summary: get('profile-summary'),
            topRolesContainer: get('top-roles-container'), gatedContent: get('gated-content'),
            gatedRolesWrapper: get('gated-roles-container'), clarity: get('clarity-container'),
            overallFlex: get('overall-flex-badge'), jsonOut: get('json-output')
        };

        const traits = {
            ANALYTICAL: { name: 'Logic Expert', raw: 0 },
            DECISIVE: { name: 'Tactical Responder', raw: 0 },
            METHODICAL: { name: 'Quality Guard', raw: 0 },
            LEADERSHIP: { name: 'Strategic Lead', raw: 0 },
            POLICY: { name: 'Governance Lead', raw: 0 },
            ARCHITECTURE: { name: 'Systems Architect', raw: 0 },
            DEVELOPMENT: { name: 'Secure Solutions Builder', raw: 0 },
            EDUCATION: { name: 'Workforce Enablement Lead', raw: 0 },
        };

        const cognitive = { E: 0, I: 0, S: 0, N: 0, T: 0, f: 0, J: 0, P: 0 }; // f is Human Impact
        const conflicts = { EI: 0, SN: 0, TF: 0, JP: 0 }; // Identify Flex via latency

        const workRoles = {
            'APPSEC': { 
                id: 'APPSEC', cat: 'SP', trait: 'DEVELOPMENT', mbti: 'ISTP', 
                name: 'AppSec Engineer', timeEntry: '2–4 Years',
                pathway: 'B.S. Computer Science / Software Engineering concentration',
                desc: 'Engineering security protocols directly into software pipelines.', 
                narrative: 'You blend a hands-on building mindset with a tactical focus on solving immediate technical vulnerabilities.',
                stressNote: 'Under intense deadlines, you may prioritize technical speed over documentation; ensure you align with audit trails.',
                skills: ['Python/Go', 'SAST/DAST', 'CI/CD Automation'], certs: ['CSSLP', 'GWEB']
            },
            'ARCHITECT': { 
                id: 'ARCHITECT', cat: 'SP', trait: 'ARCHITECTURE', mbti: 'INTJ', 
                name: 'Security Architect', timeEntry: '7–10 Years',
                pathway: 'M.S. Cybersecurity Engineering / Enterprise Architecture Track',
                desc: 'Designing and engineering resilient enterprise ecosystems.', 
                narrative: 'Your preference for high-level systems design allows you to build long-term defensive blueprints.',
                stressNote: 'During live incidents, you may over-analyze root causes; trust tactical responders for immediate triage while you look for patterns.',
                skills: ['Zero Trust', 'Cloud Design', 'Network Strategy'], certs: ['SABSA', 'CISSP-ISSAP']
            },
            'GRC': { 
                id: 'GRC', cat: 'OV', trait: 'POLICY', mbti: 'ISTJ', 
                name: 'GRC Specialist', timeEntry: '1–3 Years',
                pathway: 'Information Systems Management / Business Risk Admin',
                desc: 'Ensuring alignment between operations and regulatory standards.', 
                narrative: 'Your methodical nature and focus on organizational governance make you ideal for rigorous auditing.',
                stressNote: 'Under crisis pressure, rigid adherence to standard protocols may hinder rapid improvisation.',
                skills: ['NIST CSF', 'ISO 27001', 'Risk Auditing'], certs: ['CISA', 'CRISC']
            },
            'SOC': { 
                id: 'SOC', cat: 'PR', trait: 'DECISIVE', mbti: 'ISTP', 
                name: 'SOC Analyst', timeEntry: '0–2 Years',
                pathway: 'Cyber Defense Certificate / Security Operations Specialist',
                desc: 'Front-line triage and real-time monitoring of security events.', 
                narrative: 'You thrive in high-pressure environments that require rapid, evidence-based tactical decisions.',
                stressNote: 'Extended high-alert periods can cause mental fatigue; pivot to proactive hunting tasks to maintain focus.',
                skills: ['SIEM Triage', 'KQL/SPL', 'Traffic Analysis'], certs: ['CYSA+', 'Splunk Power User']
            },
            'CTI': { 
                id: 'CTI', cat: 'AN', trait: 'ANALYTICAL', mbti: 'INTP', 
                name: 'Threat Intel Analyst', timeEntry: '2–5 Years',
                pathway: 'Intelligence Studies / Advanced Data Analytics',
                desc: 'Deep-dive profiling of adversary behaviors and motivations.', 
                narrative: 'Your analytical curiosity allows you to connect disparate data points into cohesive threat profiles.',
                stressNote: 'Information overload can lead to analysis paralysis; focus reporting on the top three most impactful TTPs.',
                skills: ['Intelligence Cycle', 'STIX/TAXII', 'Strategic Writing'], certs: ['GCTI', 'CTIA']
            },
            'EXPL': { 
                id: 'EXPL', cat: 'CO', trait: 'ANALYTICAL', mbti: 'INTP', 
                name: 'Exploitation Analyst', timeEntry: '5–8 Years',
                pathway: 'Computer Engineering (Offensive / Kernel Focus)',
                desc: 'Specialized research into target system vulnerabilities.', 
                narrative: 'You excel at dismantling complex technical systems to find unconventional paths to access.',
                stressNote: 'Complex obstacles can lead to extreme tunnel vision; rotate your perspective frequently.',
                skills: ['Reverse Engineering', 'C/C++', 'Protocol Fuzzing'], certs: ['GREM', 'OSCE']
            }
        };

        const cogAxes = [['E','I'], ['S','N'], ['T','f'], ['J','P']];
        const stage1Questions = [];
        const traitKeys = Object.keys(traits);

        // Phase 1 Core Situational Anchors
        const situations = [
            { a: { text: "Solving a complex logic puzzle independently.", trait: 'ANALYTICAL', cog: 'I', axis: 'EI' }, b: { text: "Leading a mission-critical group briefing.", trait: 'LEADERSHIP', cog: 'E', axis: 'EI' } },
            { a: { text: "Performing urgent repairs during a major outage.", trait: 'DECISIVE', cog: 'S', axis: 'SN' }, b: { text: "Drafting the long-term blueprint for resilience.", trait: 'ARCHITECTURE', cog: 'N', axis: 'SN' } },
            { a: { text: "Optimizing code for maximum processing speed.", trait: 'DEVELOPMENT', cog: 'T', axis: 'TF' }, b: { text: "Protecting user data privacy and well-being.", trait: 'POLICY', cog: 'f', axis: 'TF' } },
            { a: { text: "Adhering to a detailed technical checklist.", trait: 'METHODICAL', cog: 'J', axis: 'JP' }, b: { text: "Responding dynamically to unexpected intruders.", trait: 'DECISIVE', cog: 'P', axis: 'JP' } }
        ];
        situations.forEach((q, i) => stage1Questions.push({ id: i+1, ...q }));

        // Axis-Neutral permuted population
        for(let i=4; i<40; i++) {
            const t1 = traitKeys[i % 8], t2 = traitKeys[(i + 4) % 8];
            const axPair = cogAxes[i % 4];
            const axisKey = ['EI','SN','TF','JP'][i % 4];
            stage1Questions.push({
                id: i + 1,
                a: { text: `Prioritizing ${traits[t1].name} objectives.`, trait: t1, cog: axPair[0], axis: axisKey },
                b: { text: `Prioritizing ${traits[t2].name} objectives.`, trait: t2, cog: axPair[1], axis: axisKey }
            });
        }

        // Expanded Stage 2 Library (4 Situational Probes/Role)
        const expandedTaskBank = {
            DEVELOPMENT: [
                { id: 'D1', text: "Writing scripts to automatically block malicious IP addresses.", roles: ['APPSEC'] },
                { id: 'D2', text: "Reviewing application code to find hidden logic vulnerabilities.", roles: ['APPSEC'] },
                { id: 'D3', text: "Integrating security scanning tools into an automated pipeline.", roles: ['APPSEC'] },
                { id: 'D4', text: "Performing 'fuzz testing' to see how software handles corrupted data.", roles: ['APPSEC'] }
            ],
            ARCHITECTURE: [
                { id: 'A1', text: "Designing the secure network layout for a new cloud region.", roles: ['ARCHITECT'] },
                { id: 'A2', text: "Creating a master Zero Trust blueprint for an enterprise ecosystem.", roles: ['ARCHITECT'] },
                { id: 'A3', text: "Evaluating technical vendors to ensure hardware meets security standards.", roles: ['ARCHITECT'] },
                { id: 'A4', text: "Developing a strategic plan to migrate on-prem services to a private cloud.", roles: ['ARCHITECT'] }
            ],
            POLICY: [
                { id: 'P1', text: "Reviewing system logs to verify audit compliance.", roles: ['GRC'] },
                { id: 'P2', text: "Assessing the security risk posed by a new software vendor.", roles: ['GRC'] },
                { id: 'P3', text: "Drafting an organization's formal disaster recovery plan.", roles: ['GRC'] },
                { id: 'P4', text: "Mapping technical security controls to legal and privacy regulations.", roles: ['GRC'] }
            ],
            DECISIVE: [
                { id: 'C1', text: "Managing an active containment effort while a breach is in progress.", roles: ['SOC'] },
                { id: 'C2', text: "Correlating system logs to trace the path of an intruder.", roles: ['SOC'] },
                { id: 'C3', text: "Performing triage on suspicious files to identify malware behavior.", roles: ['SOC'] },
                { id: 'C4', text: "Monitoring network traffic alerts to identify true malicious positives.", roles: ['SOC'] }
            ],
            ANALYTICAL: [
                { id: 'Y1', text: "Tracking the motivations and TTPs of cybercrime groups.", roles: ['CTI'] },
                { id: 'Y2', text: "Dismantling computer files to reverse engineer their code.", roles: ['EXPL'] },
                { id: 'Y3', text: "Mapping newly discovered attacker tactics to the ATT&CK framework.", roles: ['CTI'] },
                { id: 'Y4', text: "Developing custom exploit code to test endpoint defense resilience.", roles: ['EXPL'] },
                { id: 'Y5', text: "Producing strategic intelligence reports for senior leadership.", roles: ['CTI'] },
                { id: 'Y6', text: "Reverse engineering firmware to find low-level kernel bugs.", roles: ['EXPL'] }
            ]
        };

        const ratingLabels = [
            { l: 'None', desc: 'No interest' }, { l: 'Low', desc: 'Occasionally fine' },
            { l: 'Moderate', desc: 'Enjoy doing this' }, { l: 'Strong', desc: 'Primary focus' }
        ];

        let cur1 = 0, cur2 = 0, stage2Set = [], scores = {}, maxScores = {}, telemetry = {}, userPrimaryTraits = [];

        function start1() {
            elements.startScreen.classList.add('hidden');
            elements.quiz1.classList.remove('hidden');
            cur1 = 0;
            telemetry = { stage1: [], consent: elements.consentCheckbox.checked, conflicts: [] };
            Object.keys(traits).forEach(t => traits[t].raw = 0);
            Object.keys(cognitive).forEach(k => cognitive[k] = 0);
            Object.keys(conflicts).forEach(k => conflicts[k] = 0);
            show1();
        }

        function show1() {
            elements.container1.innerHTML = '';
            if (cur1 < stage1Questions.length) {
                const q = stage1Questions[cur1];
                const pct = ((cur1 + 1) / stage1Questions.length) * 100;
                elements.progBar1.style.width = `${pct}%`;
                elements.count1.textContent = `Diagnostic Probe ${cur1 + 1} / 40`;
                elements.progText1.textContent = `${Math.round(pct)}%`;
                const startTime = performance.now();
                ['a', 'b'].forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = "p-6 bg-gray-900/40 border border-gray-700 rounded-2xl hover:border-cyan-500 text-left transition-all active:scale-95 group focus:ring-2 focus:ring-cyan-500";
                    btn.innerHTML = `<span class="trait-label mb-2 block group-hover:text-cyan-400">Environment ${c.toUpperCase()}</span>${q[c].text}`;
                    btn.onclick = () => {
                        const latency = (performance.now() - startTime) / 1000;
                        traits[q[c].trait].raw++;
                        cognitive[q[c].cog]++;
                        if (latency > 20) conflicts[q[c].axis]++; 
                        if (telemetry.consent) telemetry.stage1.push({ t: q[c].trait, c: q[c].cog, lat: latency });
                        cur1++;
                        show1();
                    };
                    elements.container1.appendChild(btn);
                });
            } else {
                elements.quiz1.classList.add('hidden');
                elements.intermediate.classList.remove('hidden');
            }
        }

        function getCognitiveStats() {
            const axes = [{l:'E',r:'I',k:'EI'}, {l:'S',r:'N',k:'SN'}, {l:'T',r:'f',k:'TF'}, {l:'J',r:'P',k:'JP'}];
            let type = '', flexCount = 0;
            const clarity = axes.map(axis => {
                const l = cognitive[axis.l], r = cognitive[axis.r];
                const total = l + r;
                const pos = total === 0 ? 50 : (r / total) * 100;
                if (Math.abs(50 - pos) < 15) flexCount++;
                type += (l >= r ? axis.l : axis.r);
                return { left: axis.l, right: axis.r.toUpperCase(), pos, isConflict: conflicts[axis.k] > 2 };
            });
            return { type, clarity, flexRating: flexCount };
        }

        function start2() {
            elements.intermediate.classList.add('hidden');
            elements.quiz2.classList.remove('hidden');
            const raw = Object.values(traits).map(t => t.raw);
            const min = Math.min(...raw), max = Math.max(...raw);
            telemetry.stage1Normalized = Object.fromEntries(Object.entries(traits).map(([k, v]) => [k, Math.round(((v.raw - min) / (max - min)) * 100)]));
            const sorted = Object.entries(telemetry.stage1Normalized).sort((a,b) => b[1] - a[1]);
            userPrimaryTraits = [sorted[0][0]];
            if (sorted[1] && sorted[0][1] - sorted[1][1] <= 15) userPrimaryTraits.push(sorted[1][0]);

            let pool = [];
            userPrimaryTraits.forEach(t => { if (expandedTaskBank[t]) pool.push(...expandedTaskBank[t]); });
            if(pool.length < 8) {
                const otherTraits = Object.keys(expandedTaskBank).filter(t => !userPrimaryTraits.includes(t));
                otherTraits.forEach(t => pool.push(expandedTaskBank[t][0]));
            }

            stage2Set = pool.map((q, i) => ({ ...q, localId: `S2-${i}` }));
            cur2 = 0;
            scores = {}; maxScores = {};
            Object.keys(workRoles).forEach(id => { scores[id] = 0; maxScores[id] = 0; });
            stage2Set.forEach(q => { q.roles.forEach(rid => { if(maxScores[rid] !== undefined) maxScores[rid] += 3; })});
            show2();
        }

        function show2() {
            if (cur2 < stage2Set.length) {
                const q = stage2Set[cur2];
                const pct = ((cur2 + 1) / stage2Set.length) * 100;
                elements.progBar2.style.width = `${pct}%`;
                elements.count2.textContent = `Phase 2: Task ${cur2 + 1} / ${stage2Set.length}`;
                elements.interestText.textContent = q.text;
                elements.container2.innerHTML = '';
                ratingLabels.forEach((r, v) => {
                    const btn = document.createElement('button');
                    btn.className = "bg-gray-700 hover:bg-cyan-600 p-4 rounded-xl transition-all text-center group active:scale-95 focus:ring-2 focus:ring-cyan-500";
                    btn.innerHTML = `<span class="font-bold text-white">${r.l}</span><span class="rating-anchor group-hover:text-cyan-100">${r.desc}</span>`;
                    btn.onclick = () => {
                        q.roles.forEach(rid => { if(scores[rid] !== undefined) scores[rid] += v; });
                        cur2++;
                        show2();
                    };
                    elements.container2.appendChild(btn);
                });
            } else {
                showResults();
            }
        }

        function showResults() {
            elements.quiz2.classList.add('hidden');
            elements.results.classList.remove('hidden');
            const { type, clarity, flexRating } = getCognitiveStats();
            elements.summary.innerHTML = `<span class="text-4xl font-black text-white uppercase tracking-tighter">${type.toUpperCase()}</span><p class="text-cyan-400 font-mono text-sm mt-1 uppercase tracking-widest">NICE Framework Vector Analysis</p>`;

            const flexLabels = ["Specialized", "Balanced", "Versatile", "Bridge Profile", "Adaptive Master"];
            elements.overallFlex.innerHTML = `<span class="px-4 py-1 bg-cyan-500/20 text-cyan-300 rounded-full text-[10px] font-bold uppercase tracking-widest border border-cyan-500/30">${flexLabels[flexRating]}</span>`;

            elements.clarity.innerHTML = clarity.map(s => `
                <div class="space-y-2">
                    <div class="flex justify-between trait-label items-center">
                        <span>${s.left}</span>
                        ${s.isConflict ? '<span class="conflict-badge">Identity Flex</span>' : ''}
                        <span>${s.right}</span>
                    </div>
                    <div class="clarity-bar-bg"><div class="clarity-fill" style="width: ${s.pos}%"></div></div>
                </div>`).join('');

            const resultsData = Object.values(workRoles).map(role => {
                const interestPct = maxScores[role.id] > 0 ? (scores[role.id] / maxScores[role.id]) * 100 : 0;
                let match = 0; for(let i=0; i<4; i++) if(type[i].toUpperCase() === role.mbti[i].toUpperCase()) match++;
                const mbtiSim = (match / 4) * 100;
                const traitAlign = userPrimaryTraits.includes(role.trait) ? 100 : 25;
                const finalScore = (interestPct * 0.5) + (mbtiSim * 0.3) + (traitAlign * 0.2);
                return { ...role, finalScore };
            });

            const sorted = resultsData.sort((a,b) => b.finalScore - a.finalScore);
            elements.topRolesContainer.innerHTML = sorted.slice(0,3).map(r => `
                <div class="bg-gray-900/60 border border-gray-700 p-8 rounded-3xl hover:border-cyan-500/50 transition-all group text-left">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex-1 pr-4">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-2xl font-bold text-white group-hover:text-cyan-400 transition-colors">${r.name}</h3>
                                <span class="time-badge">${r.timeEntry} to entry</span>
                            </div>
                            <p class="text-gray-400 text-sm italic leading-relaxed">${r.desc}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-4xl font-black text-cyan-400 leading-none">${Math.round(r.finalScore)}%</div>
                            <div class="text-[9px] font-bold text-gray-500 uppercase mt-1">Vector Match</div>
                        </div>
                    </div>
                    <div class="p-5 bg-cyan-500/5 rounded-2xl mb-6 border border-cyan-500/10">
                        <span class="text-[10px] font-black text-cyan-500 uppercase block mb-1">Strategic Reasoning</span>
                        <p class="text-xs text-gray-300 leading-relaxed mb-4">${r.narrative}</p>
                        <span class="text-[10px] font-black text-amber-500 uppercase block mb-1">Cognitive Stress Predictor</span>
                        <p class="text-xs text-amber-200/70 leading-relaxed italic">${r.stressNote}</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div><span class="trait-label">Framework Knowledge</span><div class="text-[11px] text-gray-400 mt-2">${r.skills.join(', ')}</div></div>
                        <div><span class="trait-label">Academic Track</span><div class="text-[11px] text-gray-400 mt-2">${r.pathway}</div></div>
                    </div>
                </div>`).join('');

            const gated = sorted.slice(3);
            elements.gatedContent.innerHTML = gated.map(r => `
                <div class="flex justify-between items-center bg-gray-800/40 p-4 rounded-xl border border-gray-700">
                    <span class="text-sm font-bold text-gray-300 text-left">${r.name}</span>
                    <div class="flex items-center gap-4">
                        <span class="text-[10px] text-gray-500 uppercase">${r.timeEntry}</span>
                        <span class="text-xs font-mono text-cyan-500">${Math.round(r.finalScore)}% Match</span>
                    </div>
                </div>`).join('');
            if (gated.length > 0) elements.gatedRolesWrapper.classList.remove('hidden');
        }

        elements.startBtn.onclick = start1;
        elements.startStage2Btn.onclick = start2;
        elements.restartBtn.onclick = () => window.location.reload();
        elements.exportBtn.onclick = () => { 
            elements.jsonOut.value = JSON.stringify(telemetry.consent ? telemetry : { optOut: true }, null, 2); 
            elements.exportModal.classList.remove('hidden'); 
        };
        elements.closeModalBtn.onclick = () => elements.exportModal.classList.add('hidden');
        elements.toggleGatedBtn.onclick = () => elements.gatedContent.classList.toggle('hidden');
    });
    </script>
</body>
</html>
